# Электронные транспортные накладные (ЭТРН)

Этот раздел описывает методы API CARGO.RUN, предназначенные для работы с электронными транспортными накладными (ЭТРН) со стороны внешней системы (например, 1С).

Используются три основных метода:

- получение списка титулов со статусами;
- получение данных одного титула;
- смена статуса титула.

Общие принципы работы API и авторизации см.:

- [Обзор API](./api/_overview.md)
- [Auth API](./api/auth.md)

---

## 1. Получение списка титулов со статусами

```http
GET /api/1c/bills/gettitles
```

### Назначение

Получение списка титулов ЭТРН с их текущими статусами в формате OData.

Метод возвращает коллекцию `TitleExternalModel`, в которой для каждого титула указаны:

- `id` — идентификатор титула;
- `type` — тип титула (`TitleType`);
- `status` — статус (`TitleStatus`);
- `statusDate` — дата и время изменения статуса;
- `bill` — данные по накладной (`EBillExternalModel`).

[Статусы титулов ЭТРН](./statuses.md#4-статусы-титулов-этрн

### Параметры запроса

Метод поддерживает стандартные OData-параметры:

- `$filter` — фильтр по полям модели `TitleExternalModel`;
- `$orderBy` — сортировка;
- `$top` — ограничение количества;
- `$skip` — смещение;
- `$count` — возврат количества записей;
- `$select` — выбор полей.

Примеры:

1. Получить все титулы в статусе `Received`:

```text
GET /api/1c/bills/gettitles?$filter=status eq 'Received'
```

2. Получить первые 50 титулов, отсортированных по дате статуса:

```text
GET /api/1c/bills/gettitles?$orderby=statusDate desc&$top=50
```

---

## 2. Получение титула по заявке

```http
/api/1c/Bills/GetTitle?titleId={titleId}&bidId={bidId}&bidExternalId={bidExternalId}
```

### Назначение

Получение данных одного титула ЭТРН.

Метод может искать титул:

- по идентификатору заявки и по идентификатору титула,
- по внешнему идентификатору заявки и по идентификатору титула.

### Параметры запроса

Метод поддерживает следующие query-параметры:

- `titleId` — идентификатор титула (int64);
- `bidId` — идентификатор заявки (int64);
- `bidExternalId` — внешний идентификатор заявки (string).

Ответ — модель `TitleWithRemarksExternalModel`, содержащая:

- данные титула;
- статус и дату статуса;
- комментарии и замечания (если есть).

---

## 3. Смена статуса титула

```http
POST /api/1c/bills/applystatus
```

### Назначение

Изменение статуса титула ЭТРН со стороны внешней системы.

Метод позволяет:

- подтвердить титул;
- отклонить титул;
- зафиксировать факт отправки статуса в CARGO.RUN.

### Тело запроса

Тело описано моделью `TitleStatusApplyExternalModel`:

```json
{
  "id": 0,
  "status": "Accepted",
  "bidId": 0,
  "bidExternalId": "string"
}
```

Поля:

- `id` — идентификатор титула (обязательное поле);
- `status` — новый статус титула (обязательное поле);
- `bidId` — идентификатор заявки (опционально);
- `bidExternalId` — внешний идентификатор заявки (опционально).

### Поддерживаемые значения статуса

Список статусов задаётся enum `TitleStatus`

- `Received`
- `Accepted`
- `Declined`
- `SentToCrEBill`

---

## 4. Сводка методов

| Метод | Описание |
|-------|----------|
| `GET /api/1c/bills/gettitles` | Получение списка титулов ЭТРН со статусами (OData) |
| `GET /api/1c/bills/gettitle`  | Получение одного титула по идентификатору титула или заявки |
| `POST /api/1c/bills/applystatus` | Смена статуса титула ЭТРН |

